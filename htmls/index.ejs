<html>

<head>

    <link rel="stylesheet" href="/css/modules/index.css">
    <title>书签导航转换器</title>
    <link rel="stylesheet" href="/css/editormd.min.css">

    <script src="/plugins/switch/index.min.js"></script>

    <script src="/js/echarts.min.js"></script>

    <script src="/plugins/nice-select/js/jquery.nice-select.js"></script>
    <link rel="stylesheet" href="/plugins/nice-select/css/nice-select.css">

    <!-- filepond start -->
    <link rel="stylesheet" href="/plugins/filepond/dist/filepond.min.css">
    <script src="/plugins/filepond/dist/filepond.min.js"></script>
    <script src="/plugins/filepond/filepond.jquery.js"></script>
    <script src="/plugins/filepond/preview/preview.js"></script>
    <link rel="stylesheet" href="/plugins/filepond/preview/preview.css">
    <script src="/plugins/filepond/validate/type.js"></script>
    <script src="/plugins/filepond/validate/size.js"></script>
    <!-- filepond end -->
</head>

<body>
    <section id="container" class="scroll-999">
        <div class="flex justify-between align-center page-title ">
            <h2 class="flex align-center">
                <a id="leftController" class="left-controller ml-5px">
                    <i class="iconfont icon-category"></i>
                </a>
                <a href="/" class="color-fff ml-16px">书签导航转换器</a>
            </h2>
            <div class="mt-0px mb-0px pd-16px  color-fff ">

                <a href="/manager" class="color-fff font-15px">
                    <i class="iconfont icon-nav_icon_xitongshezhi color-fff"></i>内容管理
                </a>
            </div>
        </div>



        <section id="typeForm" class="dialog">
            <div class="dialog-mask"></div>
            <div class="dialog-content">
                <div class="dialog-header">添加分类</div>
                <div class="dialog-body">
                     <form action="/api/admin/addCategory" method="post" enctype="multipart/form-data" class="common-form">
                         <input type="text" name="id" style="display: none">
                       <div class="common-form-item">
                           <label for="name">分类名称</label>
                           <input id="renameOldType" name="name" placeholder="" autocomplete="off"  class="common-input">
                       </div>
                       <div class="common-btn-group justify-end">
                           <button class="submit common-btn primary" type="submit">提交</button>
                           <a class=" common-btn  dialog-cancel" >取消</a>
                       </div>
                   </form>
                </div>
            </div>
        </section>

        <section id="typeFormRename" class="dialog">
            <div class="dialog-mask"></div>
            <div class="dialog-content">
                <div class="dialog-header">导入书签</div>
                <div class="dialog-body">
                  <form action="/api/admin/importbookmarks" method="post" enctype="multipart/form-data" class="common-form">
                      <input type="text" name="id"  value="" style="display: none">
<!--                    <div class="common-form-item">-->
<!--                        <label for="title">应用名称</label>-->
<!--                        <input id="title" name="title" placeholder="请输入应用名称" autocomplete="off"  class="common-input">-->
<!--                    </div>-->
<!--                    <div class="common-form-item">-->
<!--                        <label for="desp">应用描述</label>-->
<!--                        <input id="desp" name="desp" placeholder="请输入应用描述" autocomplete="off" class="common-input">-->
<!--                    </div>-->
                      <div class="common-form-item" style="display: block; position: relative; height: 200px;">
                          <label for="bookmark" class="mb-12px">书签备份文件（html）</label>
                          <input id="bookmark" type="file" name="bookmark" placeholder="请上传书签备份文件" autocomplete="off" class="common-input">
                      </div>
                      <div class="common-form-item">
                          <label for="categoryId" >书签分类</label>
                          <select name="categoryId" id="categoryId"></select>
                      </div>
<!--                      <div class="common-form-item">-->
<!--                          <label for="ishttps">是否为https</label>-->
<!--                          <input type="checkbox" id="ishttps" name="ishttps" class="dis-none"-->
<!--                                 value=""-->
<!--                                 style="display: none">-->
<!--                          <jelly-switch-->
<!--                                  id="jellySwitchHttps"-->
<!--                                  onToggle="handleToggle('ishttps')"></jelly-switch>-->
<!--                      </div>-->


                    <div class="common-btn-group justify-end">
                        <button class="submit common-btn primary" type="submit">提交</button>
                        <button class=" common-btn  dialog-cancel" >取消</button>
                    </div>
                </form>
                </div>
            </div>
        </section>


        <section id="groupForm" class="dialog">
            <div class="dialog-mask"></div>
            <div class="dialog-content">
                <div class="dialog-header">修改分组名称</div>
                <div class="dialog-body">
                    <form action="/api/admin/updateGroup" method="post" enctype="multipart/form-data" class="common-form">
                        <input type="text" name="id" style="display: none">
                        <div class="common-form-item">
                            <label for="name">分组名称</label>
                            <input id="groupName" name="name" placeholder="" autocomplete="off"  class="common-input">
                        </div>

                        <div class="common-form-item">
                            <label for="categoryId" >书签分类</label>
                            <select name="categoryId" id="groupCategoryId"></select>
                        </div>
                        <div class="common-btn-group justify-end">
                            <button class="submit common-btn primary" type="submit">提交</button>
                            <a class=" common-btn  dialog-cancel" >取消</a>
                        </div>
                    </form>
                </div>
            </div>
        </section>



        <section id="bookmarkForm" class="dialog">
            <div class="dialog-mask"></div>
            <div class="dialog-content">
                <div class="dialog-header">修改分组名称</div>
                <div class="dialog-body">
                    <form action="/api/admin/updateGroup" method="post" enctype="multipart/form-data" class="common-form">
                        <input type="text" name="id" style="display: none">
                        <div class="common-form-item">
                            <label for="name">书签名称</label>
                            <input id="bookmarkName" name="name" placeholder="" autocomplete="off"  class="common-input">
                        </div>

                        <div class="common-form-item">
                            <label for="href">跳转链接</label>
                            <input  name="href" placeholder="" autocomplete="off"  class="common-input">
                        </div>
                        <div class="common-form-item" style="display: block; height: 230px">
                            <label for="icon">图标</label>
                            <input type="file" id="iconInput"  accept="image/*"  name="icon" placeholder="" autocomplete="off"  class="common-input">
                        </div>

                        <div class="common-form-item">
                            <label for="groupId" >书签分组</label>
                            <select name="groupId" id="formGroupId"></select>
                        </div>
                        <div class="common-btn-group justify-end">
                            <button class="submit common-btn primary" type="submit">提交</button>
                            <a class=" common-btn  dialog-cancel" >取消</a>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <div class="flex h-100per">
            <section id="typeLeft" class="typeLeft-hidden">



                <div class="flex justify-end">
                    <a id="exitTypeLeft">
                        <i class="iconfont icon-exit"></i>
                    </a>
                </div>

                <div class="custom-nav">
                    <a href="/" class=" flex justify-center w-100per">
                        <img src="/images/logo.jpg" alt="" class="w-130px h-130px rd-130px" style="object-fit: cover">
                    </a>
                    <a class="add-type flex add-type-top" data-type="" onclick="showCategoryAdd()">+添加分类</a>

                </div>
                <div class="md-menu">
                    <%categorys.forEach(function(item, k){%>
                    <a class="type-item flex <%-item.id === id ? 'active' : ''%>" data-type="<%-item.id%>" href="/?id=<%-item.id%>">
                        <span><%-item.name%></span>
                        <i class="iconfont icon-right"></i>
                    </a>
                    <%})%>
                </div>
            </section>
            <section id="editRight">
                <div class="dashboard">
<!--                    <div class="dashboard-title">欢迎来到文档管理系统！</div>-->
                    <div class="">

                        <div class="common-btn-group">
                            <%if(id !== undefined) {%>
                                <a class="common-btn flex primary" data-type="" onclick="updateCategory('<%-id%>')">修改分类名称</a>
                                <a class="common-btn danger" onclick="deleteCategory()">-删除分类</a>
                                <a class="common-btn danger" onclick="clearCategory()">-清空分类</a>
                            <%}%>
                        </div>
                        <div class="mt-16px">
                            <a class="common-btn flex primary" data-type="" onclick="groupAddShow()">+新增书签分组</a>
                            <a class="common-btn flex primary" data-type="" onclick="showBookmarkImport()">+导入书签</a>
                        </div>
                    </div>




                    <div id="appsContainer">

                        <% groupList.forEach(function(item0, k0){%>
                            <div class="group-item">
                                <div class="flex justify-between align-center">
                                    <h3><%-item0.name%></h3>
                                    <div class="common-btn-group">
                                        <a class="common-btn primary" onclick="showAddBookmark('<%-item0.id%>')">+新增书签</a>
                                        <a class="common-btn primary" onclick="groupUpdateShow('<%-item0.id%>', '<%-item0.name%>')"> 名称修改</a>
                                        <a onclick="deleteGroup('<%-item0.id%>')" class="common-btn danger">删除</a>
                                    </div>
                                </div>
                                <div class="bookmarks">
                                    <% item0.bookmarks.forEach(function(item1, k1){%>
                                            <div class="bookmark-item" >
                                                <div class="bookmark-a-div">
                                                    <img src="<%-item1.icon%>" alt="">
                                                    <p><%-item1.name%></p>
                                                </div>
                                                <div class="bookmark-controllers">
                                                    <a class="bookmark-item-link" href="<%-item1.href%>" target="_blank">跳转链接</a>
                                                    <a  class="bookmark-item-update" onclick="showUpdateBookmark('<%-item1.id%>', '<%-item0.id%>')">修改</a>
                                                    <a class="bookmark-item-delete" onclick="deleteBookmark('<%-item1.id%>')">删除</a>
                                                </div>
                                            </div>
                                    <%})%>
                                </div>
                            </div>
                        <%})%>
                    </div>



                </div>

            </section>
        </div>


    </section>


    <script src="/js/jquery_dom.js"></script>

    <script>
        showMessage(`<%- typeof success !== 'undefined' && success %>`, `<%- typeof message !== 'undefined' && message %>`)
    </script>

<script>
    $(".bookmark-a-div").on("click", function (ev) {
        if($(this).siblings(".bookmark-controllers").hasClass("show")) {
            $(this).siblings(".bookmark-controllers").removeClass("show")
        } else {
            $(this).siblings(".bookmark-controllers").addClass("show")
        }
    })
    var categorys = JSON.parse(`
                            <%-JSON.stringify(categorys)%>
                        `)
    var groupList = <%-JSON.stringify(groupList)%>

    $("#leftController").on('click', function () {
        $("#typeLeft").toggleClass("typeLeft-hidden")
    })
    $("#exitTypeLeft").on('click', function () {
        $("#typeLeft").addClass("typeLeft-hidden")
    })

    function showCategoryAdd(){
        $("#typeForm .dialog-header").text("新增分类")
        $("#typeForm").show()
        $("#typeForm form").attr("action", "/api/admin/addCategory").find('input[name="name"]').val("")
        $("#typeForm form input[name='id']").val("")
    }
    function updateCategory(id) {
        if(!id) return
        $("#typeForm .dialog-header").text("修改分类")
         $("#typeForm").show()
         $("#typeForm form").attr("action", "/api/admin/updateCategory").find('input[name="name"]').val(categorys.find(item => item.id === id).name)
        $("#typeForm form input[name='id']").val(id)
    }

    function showBookmarkImport() {
        $("#typeFormRename").show()
        var categoryHtml = ''
        categorys.forEach(item => {
            categoryHtml += `<option value="${item.id}">${item.name}</option>`
        })
        $("#categoryId").html(categoryHtml).niceSelect()
        $("#categoryId option[value='<%-id%>']").attr("selected", true)
        $("#categoryId").niceSelect("update")
    }

    function groupAddShow() {
        $("#groupForm .dialog-header").text("新增书签分组")

        $("#groupForm").show().find("form").attr("action", "/api/admin/addGroup").find("input[name='id']").val("")

        $("#groupForm form input[name='name']").val("")
        var categoryHtml = ''
        categorys.forEach(item => {
            categoryHtml += `<option value="${item.id}">${item.name}</option>`
        })
        $("#groupCategoryId").html(categoryHtml).niceSelect()
        $("#groupCategoryId option[value='<%-id%>']").attr("selected", true)
        $("#groupCategoryId").niceSelect("update")
    }
    function groupUpdateShow(id,name) {
        $("#groupForm .dialog-header").text("修改书签分组")
        $("#groupForm").show().find("form").attr("action", "/api/admin/updateGroup").find("input[name='id']").val(id)
        $("#groupForm form input[name='name']").val(name)

        var categoryHtml = ''
        categorys.forEach(item => {
            categoryHtml += `<option value="${item.id}">${item.name}</option>`
        })
        $("#groupCategoryId").html(categoryHtml).niceSelect()
        $("#groupCategoryId option[value='<%-id%>']").attr("selected", true)
        $("#groupCategoryId").niceSelect("update")
    }


    function showAddBookmark(groupId) {
        $("#bookmarkForm .dialog-header").text("新增书签")

        $("#bookmarkForm").show().find("form").attr("action", "/api/admin/addBookmark").find("input[name='id']").val("")

        $("#bookmarkForm form input[name='name']").val("")
        var categoryHtml = ''
        groupList.forEach(item => {
            categoryHtml += `<option value="${item.id}">${item.name}</option>`
        })

        $("#bookmarkForm form  input[name='href']").val("")
        $("#bookmarkForm form  input[name='icon']").val("")
        $("#formGroupId").html(categoryHtml).niceSelect()
        $(`#formGroupId option[value='${groupId}']`).attr("selected", true)
        $("#formGroupId").niceSelect("update")
        pond1.removeFiles()
    }

    function showUpdateBookmark(id, groupId){
        $("#bookmarkForm .dialog-header").text("修改书签")
        $("#bookmarkForm").show().find("form").attr("action", "/api/admin/updateBookmark").find("input[name='id']").val(id)
        var _bookmark = groupList.find(item => item.id === groupId).bookmarks.find(item1 => item1.id === id)

        // console.log(_bookmark)
        $("#bookmarkForm form input[name='href']").val(_bookmark.href)
        // $("#bookmarkForm form  input[name='icon']").val()
        $("#bookmarkForm form  input[name='name']").val(_bookmark.name)
        var categoryHtml = ''
        groupList.forEach(item => {
            categoryHtml += `<option value="${item.id}">${item.name}</option>`
        })
        $("#formGroupId").html(categoryHtml).niceSelect()
        $(`#formGroupId option[value='${groupId}']`).attr("selected", true)
        $("#formGroupId").niceSelect("update")
        pond1.addFile(_bookmark.icon.replace(/\\/g, "/"))
    }


    function deleteCategory() {
        newConfirm({
            title: '删除分类',
            content: '确定删除该分类吗？',
            ok: function () {
                $.ajax({
                    url: '/api/admin/deleteCategory',
                    data: {
                        id: categoryId
                    },
                    success: function (res) {
                        if (res.success) {
                            window.location.href = '/?success=1&message=删除成功'
                        }
                    }
                })
            }
        })


    }
    function clearCategory() {
        newConfirm({
            title: '清空分类',
            content: '确定清空该分类下的所有书签吗？',
            ok: function () {
                $.ajax({
                    url: '/api/admin/clearCategory',
                    data: {
                        categoryId: categoryId
                    },
                    success: function (res) {
                        if (res.success) {
                            window.location.href = '/?success=1&message=清空成功'
                        }
                    }
                })
            }
        })
    }
    function deleteGroup(groupId) {
        newConfirm({
            title: '提示',
            content:"确定要删除本分组吗？",
            ok: () => {
                $.ajax({
                    url: '/api/admin/deleteGroup',
                    data: {
                        groupId,
                    },
                    success: res => {
                        showMessage(res.success.toString(), res.message)
                        if(res.success === 1) {
                            window.location.href = `/?success=${res.success}&message=${res.message}`
                        }
                    }
                })
            }
        })
    }

    var categoryId = "<%-id === undefined ? '' : id%>"

    function handleToggle(id) {
        var event = window.event || arguments[0];
        // console.log(event.detail)
        $(`#${id}`).attr('checked', event.detail.value).val(event.detail.value)
    }

    function deleteBookmark (id) {
        newConfirm({
            title: '删除书签',
            content: '确定删除该书签吗？',
            ok: () => {
                $.ajax({
                    url: '/api/admin/deleteBookmark',
                    data: {
                        id: id,
                    },
                    success: res => {
                        showMessage(res.success.toString(), res.message)
                        if(res.success === 1) {
                            window.location.href = `/?success=${res.success}&message=${res.message}`
                        }
                    }
                })
            }
        })
    }

</script>




    <script type="module">
        import zh_cn from '/plugins/filepond/locale/zh-cn.js';
        FilePond.setOptions(zh_cn);
    </script>
    <script>
        var pond,pond1
        FilePond.registerPlugin(FilePondPluginFileValidateSize);
        FilePond.registerPlugin(FilePondPluginImagePreview);
        FilePond.registerPlugin(FilePondPluginFileValidateType);


        $(document).ready(function () {
             pond = FilePond.create($("#bookmark")[0]);
            pond.setOptions({
                allowMultiple: false,
                storeAsFile: true,
                maxFileSize: '5MB',
            });

            pond1 = FilePond.create($("#iconInput")[0]);
            pond1.setOptions({
                allowMultiple: false,
                storeAsFile: true,
                maxFileSize: '5MB',
            });

            // pond.addFile("")
        })

    </script>
</body>

</html>
